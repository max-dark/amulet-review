<?php


function nCapP2_getTimer($speak)
{
    global $loc_i;

    return $loc_i[getCurrentLocId()][$speak]["qv"];
}

function CapP2_resetTimer($speak)
{
    global $loc_i;

    $loc_i[getCurrentLocId()][$speak]["qv"] = time();
}

function nCapP2_begin(&$title, $speak)
{
    $time = time() - nCapP2_getTimer($speak);
    if ($time < 300) {
        $title = "Не спеши, <name>, я не могу сейчас плыть, после прошлого рейса надо подлатать кое-что. Подходи через " .
            (round(5 - $time / 60) + 1) . " минут.";
    } else {
        $title = "Ну что, поплыли?";
    }
}

function nCapP2_begin_go(&$title, &$id, $speak)
{
    if (time() - nCapP2_getTimer($speak) < 300) {
        $title = "Ок, я вернусь через пару минут";
        $id = "end";
    } else {
        $title = "Тогда вперед, не будем терять времени!!";
    }
}

function nCapP2_go(&$title, $speak)
{
    global $loc_i; // TODO: remove it

    if (time() - nCapP2_getTimer($speak) < 300) {
        $title = "Уп-с, опять что-то отвалилось, подожди пока починю, ладно?.";
    } else {
        CapP2_resetTimer($speak);
        addjournal(getCurrentLocId(), "all", "[Арамис молча и сосредоточено ведет корабль к острову]");
        $title = "Все, приехали. Передавай привет Сантьяго!";
        // TODO: добавить обработку флага
        // $game["floc"] = "x746x410";
        foreach ($loc_i["x33x1252"] as $i => $val) {
            if ($i != $speak) {
                manageNPC($i, "x33x1252", "x746x410");
                if (substr($i, 0, 2) == "u.") {
                    $f = fopen("online/" . $i, "w");
                    fputs($f, "x746x410\n" . time());
                    fclose($f);
                }
            }
        }
    };
}

return [
    'begin' => 'eval: nCapP2_begin(&$title, $speak);#Кто ты?#kor#eval: nCapP2_begin_go(&$title, &$id, $speak);#go#У меня еще масса дел, пока#end',
    'end'   => 'Ступай с миром',
    'kor'   => '[настороженно] Ты не знаешь кто я? Вообще-то эта лодка только для друзей Сантьяго. Эх, ладно, нравишься ты мне, оставайся. Авось эта скряга не обеднеет#Так куда плывет эта лодка?#kor2#Я бы предпочел путешествовать на другом корабле#dr#Ну, конечно, я и есть самый лучший друг Саньяго, все окей#begin#Спасибо, я не помешаю#begin',
    'dr'    => 'Даже так? На другой стороне острова есть пирс, быстрый хороший фрегат и все такое... Весь вопрос в том, какие у тебя отношения с законом и насколько ты обрадуешься отряду стражников у городского причала.#А ты отвезешь меня не на причал?#ar#У меня еще вопросы#kor',
    'ar'    => 'Ну конечно, зря я что ли торчу здесь посреди этих дурацких зеленых заростей? Мы втихаря высадимся на пляже, а там вдоль реки ты и сам до города, или куда тебе надо, дотопаешь. Понимаешь в чем прелесть высадиться подальше от охраняемой зоны?#Да-да, понимаю, конечно#begin#Неважно, мне надо немедленно на материк!#begin',
    'kor2'  => 'На северный полюс. Ты варежки взял, любознательный ты наш пассажир? Шучу, не обижайся. Тут только один путь - на материк.#Скажи, а можно меня высадить на неохраняемой зоне?#ar#За такие шутки в зубах бывают промежутки!#end#Ура! Я наконец-то увижу настоящего пингвина! Когда отправляемся?#begin#[обиженно оттопыриваете нижнюю губу] Ну-ну, развелось шутников...#begin',
    'go'    => 'eval: nCapP2_go(&$title, $speak);#Береги себя, Арамис!#end#Все хорошо, что хорошо кончается#end#Чтоб тебя акулы сожрали, болван!#end'
];