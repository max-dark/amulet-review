<?php

function nCapP1_getTimer($speak)
{
    global $loc_i;

    return $loc_i[getCurrentLocId()][$speak]["qv"];
}

function CapP1_resetTimer($speak)
{
    global $loc_i;

    $loc_i[getCurrentLocId()][$speak]["qv"] = time();
}

function nCapP1_begin(&$title, $speak)
{
    $time = time() - nCapP1_getTimer($speak);
    if ($time < 300) {
        $title = "Не спеши, <name>, я не могу сейчас плыть, после прошлого рейса надо подлатать кое-что. Подходи через " .
            (round(5 - $time / 60) + 1) . " минут.";
    } else {
        $title = "Ну что, поплыли?";
    }
}

function nCapP1_begin_go(&$title, &$id, $speak)
{
    if (time() - nCapP1_getTimer($speak) < 300) {
        $title = "Ок, я вернусь через пару минут";
        $id = "end";
    } else {
        $title = "Тогда вперед, не будем терять времени!!";
    }
}

function nCapP1_go(&$title, $speak)
{
    global $loc_i; // TODO: remove it

    if (time() - nCapP1_getTimer($speak) < 300) {
        $title = "Уп-с, опять что-то отвалилось, подожди пока починю, ладно?.";
    } else {
        CapP1_resetTimer($speak);
        addjournal(getCurrentLocId(), "all", "[Арамис молча и сосредоточено ведет корабль к острову]");
        $title = "Все, приехали. Передавай привет Сантьяго!";
        // TODO: добавить обработку флага
        // $game["floc"] = "x70x1252";
        foreach ($loc_i["x393x1167"] as $i => $val) {
            if ($i != $speak) {
                manageNPC($i, "x393x1167", "x70x1252");
                if (substr($i, 0, 2) == "u.") {
                    $f = fopen("online/" . $i, "w");
                    fputs($f, "x70x1252\n" . time());
                    fclose($f);
                }
            }
        }
    };
}

return [
    'begin' => 'eval: nCapP1_begin(&$title, $speak);#Кто ты?#kor#eval: nCapP1_begin_go(&$title, &$id, $speak);#go#У меня еще масса дел, пока#end',
    'end'   => 'Счастливо, <name>, не попадайся стражникам',
    'kor'   => '[настороженно] Ты не знаешь кто я? Вообще-то эта лодка только для друзей Сантьяго. Эх, ладно, нравишься ты мне, оставайся. Авось эта скряга не обеднеет#Так куда плывет эта лодка?#kor2#Я бы предпочел путешествовать на другом корабле#dr#Ну, конечно, я и есть самый лучший друг Саньяго, все окей#begin#Спасибо, я не помешаю#begin',
    'dr'    => 'Ну, иди тогда в город, у причала за южными воротами наверняка дежурит Оланд, уж он-то за казенное жалованье отвезет без проблем. Правда, если у тебя будут трудности с законом, то только вряд ли ты захочешь встречаться там со стражниками, а? Впрочем, я всегда тут#А сколько стоит проезд?#ar#У меня еще вопросы#kor',
    'ar'    => 'Говрю же, эта лодка для друзей Сантьяго, а разве друзьям билет может что-то стоить? Ну ты понимаешь, что я имею ввиду под друзьями?#Да-да, понимаю, конечно#begin#Неважно, главное доставь меня на остров#begin',
    'kor2'  => 'Ох, ну что за народ... Нет бы радовался, что отвезут бесплатно и без лишнего шума, так еще вопросами замучают. Знаешь, мне больше делать нечего как отвечать на дурацкие вопросы? Иди к причалу на юге города, поговори с Оландом. Я же скажу лишь два слова: Волчий остров#Эээ... достаточно и двух#begin#Ты хам и невежа, я ухожу!#end',
    'go'    => 'eval: nCapP1_go(&$title, $speak);#Обязательно передам#end#Будь здоров, Арамис#end#Эй, куда ты меня завез???#begin'
];