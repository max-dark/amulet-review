<?php

function nKasten_begin_qv1(&$title)
{
    if (manageItems(getCurrentLocId(), getCurrentUserId(), "", "i.q.ditrihin", "count") > 0) {
        $title = "Я поступил на службу, Дитрих сказал получить у тебя одежду и оружие";
    } else {
        $title = "";
    }
}

function nKasten_qv1(&$title)
{
    $loc = getCurrentLocId();
    $login = getCurrentUserId();

    if (manageItems($loc, $login, "", "i.q.ditrihin", "count") > 0) {
        addexp($loc, $login, 10);
        manageItems($loc, $login, "", "i.q.ditrihin", 1);
        manageItems($loc, "", $login, "i.a.e.k", 1);
        manageItems($loc, "", $login, "i.w.spear.long", 1);
        $title = "Все верно, возьми этот плащ и копье. Лента стражника остается при тебе, носи ее чтобы было видно, тогда стража у ворот будет пропускать тебя в замок в любое время.";
    } else {
        $title = "Ты что-то напутал, а где перечень Дитриха?";
    }
}

function nKasten_qv(&$title, $speak)
{
    global $loc_i;

    $loc = getCurrentLocId();
    $login = getCurrentUserId();

    if (manageItems($loc, $login, "", "i.q.ditrih", "count") > 0) {
        if (time() > $loc_i[$loc][$speak]["qv"]) {
            if (manageItems($loc, $login, "", "i.q.shaman", "count") > 0) {
                $loc_i[$loc][$speak]["qv"] = time() + rand(18000, 24000);
                manageItems($loc, $login, "", "i.q.shaman", 1);
                $title = "Помни, <name>, если вам не удастся сразу прорваться через проход, мои ребята отступят. Удачи! [подзывает несколько человек и дает всем, включая вас, попробовать зелье, у вас перед глазами темнеет и...]";
                manageNPC($login, $loc, "x1446x60");
                $npc = loadNpcById("n.strditrih");
                $npc["owner"] = $login . "|" . $login . "|" . $login . "|" . (time() + 90) . "|1";
                $loc_i[$loc]["n.strditrih1." . $login] = $npc;
                $loc_i[$loc]["n.strditrih2." . $login] = $npc;
                $loc_i[$loc]["n.strditrih3." . $login] = $npc;
                $loc_i[$loc]["n.strditrih4." . $login] = $npc;
            } else {
                $title = "Путь к проходу в горах долог и опасен. Я слышал от одного из стражников, что где-то на севере  есть шаман, у которого есть зелье, способное переместить весь отряд в пространстве. Силы зелья как раз должно хватить до прохода. Думаю, тебе стоит достать этот препарат, так как иначе воины будут подвергаться напрасному риску во время перехода.";
            }
        } else {
            $title = "К сожалению, сейчас нет свободных стражников. Я полагаю, нужное количество освободится примерно через " . round(($loc_i[$loc][$speak]["qv"] - time()) / 60) . " минут";
        }
    } else {
        $title = "Извини, военные вопросы я обсуждаю только со стражниками барона Дитриха. Вначале тебе надо поступить к нему на службу. Барона Дитриха ты можешь найти на втором этаже замка.";
    }
}

return [
    'begin' => 'Здравствуй, <name>#Кто ты?#who#Мне нужен отряд стражников, чтобы прорваться с боем через проход в горах#qv#eval: nKasten_begin_qv1(&$title);#qv1#Мне пора#end',
    'end'   => 'Удачи',
    'qv1'   => 'eval: nKasten_qv1(&$title);#Ок, пока#end',
    'qv'    => 'eval: nKasten_qv(&$title, $speak);',
    'who'   => 'Я Кастен, занимаюсь снаряжением для стражников барона Дитриха.#А Лансет во дворе разве занимается не этим же?#lans#Как мне стать стражником?#join#А я <name>, рад познакомиться#begin',
    'lans'  => 'Нет Лансет в основном готовит наемные отряды, а я занимаюсь внутренними войсками - принимаю рекрутов, выдаю обмундирование и так далее. Также я подготавливаю оряды для походов по приказу барона Дитриха.#И я могу стать стражником?#join',
    'join'  => 'Поговори с бароном Дитрихом, мы время от времени нанимаем новых рекрутов. Если ты станешь стражником, сразу получишь одежду и оружие, а также отличительный знак, который позволит тебе входить в этот замок бесплатно в любое время.#Понятно, пойду поговорю с бароном#end'
];